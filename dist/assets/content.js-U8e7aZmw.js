(function(){const l=()=>{if(document.getElementById("rubric-button"))return;const o=document.querySelector("#gradebook-actions"),e=document.createElement("button");e.id="rubric-button",e.innerText="Format The Rubrics!",e.style.marginLeft="10px",e.style.padding="5px 10px",e.style.backgroundColor="#0374B5",e.style.color="white",e.style.border="none",e.style.borderRadius="3px",e.style.cursor="pointer",e.onclick=d,o.appendChild(e)},u=o=>new Promise((e,r)=>{chrome.runtime.sendMessage({action:"fetchCSV",url:o},s=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):s&&s.success?e(s.data):r(new Error(s?s.error:"Unknown error"))})}),d=async()=>{const o=document.getElementById("rubric-button"),e=o.innerText;o.disabled=!1,o.innerText="Loading...";try{testCSV=!0;let r;testCSV?r=await new Promise((a,n)=>{chrome.runtime.sendMessage({type:"getTestCSV"},t=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):t&&t.success?a(t.data):n(new Error(t?t.error:"Unknown error"))})}):r=await w();const s=await new Promise((a,n)=>{chrome.runtime.sendMessage({type:"sortData",data:r},t=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):t&&t.success?a(t):n(new Error(t?t.error:"Unknown error"))})}),i=await m();url=await new Promise((a,n)=>{chrome.runtime.sendMessage({type:"formatTheRubrics",data:s.data,standards:s.standards,id:i},t=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):t&&t.success?a(t.url):n(new Error(t?t.error:"Unknown error"))})}),console.log(url),window.open(url,"_blank"),alert("Rubrics formatted and sent to sheet successfully!")}catch(r){console.error("Error processing rubrics:",r),alert("An error occurred while processing the rubrics: "+r.message)}finally{o.disabled=!1,o.innerText=e}},m=async()=>{const o=window.prompt("Please enter a Google Sheets link with an example of the rubric format you want:");if(!o)throw new Error("No link provided");const e=o.trim();let r;if(e.includes("docs.google.com/spreadsheets")){const n=e.match(/\/d\/([a-zA-Z0-9_-]+)/);r=n?n[1]:null,console.log("Spreadsheet ID: ",r)}else e.match(/^[a-zA-Z0-9_-]+$/)&&(r=e);if(!r)throw new Error("Could not extract spreadsheet ID");const i=`${document.querySelector(".mobile-header-title div")?.textContent?.trim()||document.querySelector(".public")?.textContent?.trim()||document.querySelector("#breadcrumbs li a")?.textContent?.trim()||"Course"} Rubrics`,a=window.prompt("Enter a name for the google sheet that will have your students formatted rubrics:",i);if(!a)throw new Error("No name provided");return new Promise((n,t)=>{chrome.runtime.sendMessage({type:"COPY_SPREADSHEET",spreadsheetId:r,newName:a},c=>{chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):c.success?n(c.id):t(new Error(c.error))})})},w=async()=>{const o=window.location.pathname.match(/\/courses\/(\d+)/)?.[1];if(!o)throw new Error("Could not determine course ID");let e=document.querySelector('input[name="authenticity_token"]')?.value;if(console.log("CSRF Token found:",e?"Yes":"No"),!e)throw new Error("Could not find CSRF token");const r=await fetch(`/courses/${o}/gradebook_csv`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-Token":e,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({gradebook_csv:{include_final_grade_overrides:!0,show_inactive_enrollments:!1,include_unposted_grades:!1}}),credentials:"same-origin"});if(!r.ok)throw new Error(`Export request failed: ${r.status}`);const s=await r.json(),i=await h(s.progress_id,e,s.attachment_id);if(!i)throw new Error("Could not get CSV download URL");return await u(i)},h=async(o,e,r)=>{let i=0;for(;i<30;){i++;const a=await fetch(`/api/v1/progress/${o}`,{headers:{Accept:"application/json","X-CSRF-Token":e,"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(!a.ok){await new Promise(t=>setTimeout(t,1e3));continue}const n=await a.json();if(n.workflow_state==="completed"){const t=await fetch(`/api/v1/files/${r}`,{headers:{Accept:"application/json","X-CSRF-Token":e,"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(t.ok)return(await t.json()).url}else if(n.workflow_state==="failed")throw new Error(`Export failed: ${n.message}`);await new Promise(t=>setTimeout(t,1e3))}throw new Error("Timed out waiting for export to complete")};chrome.runtime.onMessage.addListener((o,e,r)=>{o.type==="GRADEBOOK_LOADED"&&l()});
})()
