(function(){const l=()=>{if(document.getElementById("rubric-button"))return;const o=document.querySelector("#gradebook-actions"),e=document.createElement("button");e.id="rubric-button",e.innerText="Format The Rubrics!",e.style.marginLeft="10px",e.style.padding="5px 10px",e.style.backgroundColor="#0374B5",e.style.color="white",e.style.border="none",e.style.borderRadius="3px",e.style.cursor="pointer",e.onclick=()=>u(!1),o.appendChild(e)},d=o=>new Promise((e,r)=>{chrome.runtime.sendMessage({action:"fetchCSV",url:o},t=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):t&&t.success?e(t.data):r(new Error(t?t.error:"Unknown error"))})}),u=async o=>{const e=document.getElementById("rubric-button"),r=e.innerText;e.disabled=!1,e.innerText="Loading...";try{let t;o||(t=await w());const n=await new Promise((i,s)=>{chrome.runtime.sendMessage({type:"sortData",data:t},a=>{chrome.runtime.lastError?s(new Error(chrome.runtime.lastError.message)):a&&a.success?i(a):s(new Error(a?a.error:"Unknown error"))})}),c=await m();url=await new Promise((i,s)=>{chrome.runtime.sendMessage({type:"formatTheRubrics",data:n.data,standards:n.standards,id:c},a=>{chrome.runtime.lastError?s(new Error(chrome.runtime.lastError.message)):a&&a.success?i(a.url):s(new Error(a?a.error:"Unknown error"))})}),console.log(url),window.open(url,"_blank"),alert("Rubrics formatted and sent to sheet successfully!")}catch(t){console.error("Error processing rubrics:",t),alert("An error occurred while processing the rubrics: "+t.message)}finally{e.disabled=!1,e.innerText=r}},m=async()=>{const o=window.prompt("Please enter a Google Sheets link with an example of the rubric format you want:");if(!o)throw new Error("No link provided");const e=o.trim();let r;if(e.includes("docs.google.com/spreadsheets")){const n=e.match(/\/d\/([a-zA-Z0-9_-]+)/);r=n?n[1]:null,console.log("Spreadsheet ID: ",r)}else e.match(/^[a-zA-Z0-9_-]+$/)&&(r=e);if(!r)throw new Error("Could not extract spreadsheet ID");const t=window.prompt("Enter a name for the google sheet that will have your students formatted rubrics:","Student Rubrics");if(!t)throw new Error("No name provided");return new Promise((n,c)=>{chrome.runtime.sendMessage({type:"COPY_SPREADSHEET",spreadsheetId:r,newName:t},i=>{chrome.runtime.lastError?c(new Error(chrome.runtime.lastError.message)):i.success?n(i.id):c(new Error(i.error))})})},w=async()=>{const o=window.location.pathname.match(/\/courses\/(\d+)/)?.[1];if(!o)throw new Error("Could not determine course ID");let e=document.querySelector('input[name="authenticity_token"]')?.value;if(console.log("CSRF Token found:",e?"Yes":"No"),!e)throw new Error("Could not find CSRF token");const r=await fetch(`/courses/${o}/gradebook_csv`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-Token":e,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({gradebook_csv:{include_final_grade_overrides:!0,show_inactive_enrollments:!1,include_unposted_grades:!1}}),credentials:"same-origin"});if(!r.ok)throw new Error(`Export request failed: ${r.status}`);const t=await r.json(),n=await h(t.progress_id,e,t.attachment_id);if(!n)throw new Error("Could not get CSV download URL");return await d(n)},h=async(o,e,r)=>{let n=0;for(;n<30;){n++;const c=await fetch(`/api/v1/progress/${o}`,{headers:{Accept:"application/json","X-CSRF-Token":e,"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(!c.ok){await new Promise(s=>setTimeout(s,1e3));continue}const i=await c.json();if(i.workflow_state==="completed"){const s=await fetch(`/api/v1/files/${r}`,{headers:{Accept:"application/json","X-CSRF-Token":e,"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(s.ok)return(await s.json()).url}else if(i.workflow_state==="failed")throw new Error(`Export failed: ${i.message}`);await new Promise(s=>setTimeout(s,1e3))}throw new Error("Timed out waiting for export to complete")};chrome.runtime.onMessage.addListener((o,e,r)=>{o.type==="GRADEBOOK_LOADED"&&l()});
})()
