(function(){const c=()=>{if(document.getElementById("rubric-button"))return;const o=document.querySelector("#gradebook-actions"),e=document.createElement("button");e.id="rubric-button",e.innerText="Format The Rubrics!",e.style.marginLeft="10px",e.style.padding="5px 10px",e.style.backgroundColor="#0374B5",e.style.color="white",e.style.border="none",e.style.borderRadius="3px",e.style.cursor="pointer",e.onclick=d,o.appendChild(e)},l=o=>new Promise((e,r)=>{chrome.runtime.sendMessage({action:"fetchCSV",url:o},s=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):s&&s.success?e(s.data):r(new Error(s?s.error:"Unknown error"))})}),d=async()=>{const o=document.getElementById("rubric-button"),e=o.innerText;o.disabled=!1,o.innerText="Loading...";try{testCSV=!1;let r;testCSV?r=await new Promise((i,n)=>{chrome.runtime.sendMessage({type:"getTestCSV"},t=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):t&&t.success?i(t.data):n(new Error(t?t.error:"Unknown error"))})}):r=await m();const s=await new Promise((i,n)=>{chrome.runtime.sendMessage({type:"sortData",data:r},t=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):t&&t.success?i(t):n(new Error(t?t.error:"Unknown error"))})}),a=await u();url=await new Promise((i,n)=>{chrome.runtime.sendMessage({type:"formatTheRubrics",data:s.data,standards:s.standards,id:a},t=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):t&&t.success?i(t.url):n(new Error(t?t.error:"Unknown error"))})}),console.log(url),window.open(url,"_blank"),alert("Rubrics formatted and sent to sheet successfully!")}catch(r){console.error("Error processing rubrics:",r),alert("An error occurred while processing the rubrics: "+r.message)}finally{o.disabled=!1,o.innerText=e}},u=async()=>{const o=window.prompt("Please enter a Google Sheets link with an example of the rubric format you want:");if(!o)throw new Error("No link provided");const e=o.trim();let r;if(e.includes("docs.google.com/spreadsheets")){const a=e.match(/\/d\/([a-zA-Z0-9_-]+)/);r=a?a[1]:null,console.log("Spreadsheet ID: ",r)}else e.match(/^[a-zA-Z0-9_-]+$/)&&(r=e);if(!r)throw new Error("Could not extract spreadsheet ID");const s=window.prompt("Enter a name for the google sheet that will have your students formatted rubrics:","Student Rubrics");if(!s)throw new Error("No name provided");return new Promise((a,i)=>{chrome.runtime.sendMessage({type:"COPY_SPREADSHEET",spreadsheetId:r,newName:s},n=>{chrome.runtime.lastError?i(new Error(chrome.runtime.lastError.message)):n.success?a(n.id):i(new Error(n.error))})})},m=async()=>{const o=window.location.pathname.match(/\/courses\/(\d+)/)?.[1];if(!o)throw new Error("Could not determine course ID");let e=document.querySelector('input[name="authenticity_token"]')?.value;if(console.log("CSRF Token found:",e?"Yes":"No"),!e)throw new Error("Could not find CSRF token");const r=await fetch(`/courses/${o}/gradebook_csv`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-Token":e,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({gradebook_csv:{include_final_grade_overrides:!0,show_inactive_enrollments:!1,include_unposted_grades:!1}}),credentials:"same-origin"});if(!r.ok)throw new Error(`Export request failed: ${r.status}`);const s=await r.json(),a=await w(s.progress_id,e,s.attachment_id);if(!a)throw new Error("Could not get CSV download URL");return await l(a)},w=async(o,e,r)=>{let a=0;for(;a<30;){a++;const i=await fetch(`/api/v1/progress/${o}`,{headers:{Accept:"application/json","X-CSRF-Token":e,"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(!i.ok){await new Promise(t=>setTimeout(t,1e3));continue}const n=await i.json();if(n.workflow_state==="completed"){const t=await fetch(`/api/v1/files/${r}`,{headers:{Accept:"application/json","X-CSRF-Token":e,"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(t.ok)return(await t.json()).url}else if(n.workflow_state==="failed")throw new Error(`Export failed: ${n.message}`);await new Promise(t=>setTimeout(t,1e3))}throw new Error("Timed out waiting for export to complete")};chrome.runtime.onMessage.addListener((o,e,r)=>{o.type==="GRADEBOOK_LOADED"&&c()});
})()
